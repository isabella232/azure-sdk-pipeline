parameters:
  - name: sdk
    type: string

  - name: specRepoUrl
    type: string

  - name: specRepoBaseBranch
    type: string

  - name: sdkRepoUrl
    type: string

  - name: sdkRepoBaseBranch
    type: string

steps:
  - task: NodeTool@0
    displayName: Specify Node Version
    inputs:
      versionSpec: 14.x

  - task: AzureKeyVault@2
    displayName: Get Certificate from KeyVault
    inputs:
      azureSubscription: 'Azure SDK Shanghai CodeGen Test with TTL = 1 Days(e0f413ab-64d5-48c2-859b-af46b7e8d80b)'
      KeyVaultName: 'sdk-generation-test'
      SecretsFilter: 'sdk-generation-pipeline-test'
      RunAsPreJob: true

  - bash: |
      echo "$(sdk-generation-pipeline-test)" > /tmp/sdk-generation.pem
      cat /tmp/sdk-generation.pem

  - bash: |
      npm install
      npm run build
      npm pack
      PACKAGE_TGZ=`ls sdk-generation-lib-*.tgz`
      npm install -g ${PACKAGE_TGZ}
      npm install -g autorest
    displayName: Setup Pipeline Runtime Environment
    workingDirectory: tools/sdk-generation

  - bash: |
      git clone --branch ${{ parameters.specRepoBaseBranch }} ${{ parameters.specRepoUrl }}
      git clone --branch ${{ parameters.sdkRepoBaseBranch }} ${{ parameters.sdkRepoUrl }}
      getRepoName SPEC_REPO ${{ parameters.specRepoUrl }}
      getRepoName SDK_REPO ${{ parameters.sdkRepoUrl }}
    displayName: Clone Spec Repo and Sdk Repo
    workingDirectory: ../
