#!/bin/bash
if [ -z $1 ]; then
    echo "Please input resource provider name"
fi
ResourceProvider=$1

if [ -z $2 ]; then
    echo "Please input swagger folder path"
fi
SWAGGER_PATH=$2

if [ -z $3 ]; then
    echo "Please input sdk output folder path"
fi
SDK_PATH=$3

# Generate readme config file.
cd $SWAGGER_PATH
FILE=$SWAGGER_PATH/specification/$ResourceProvider/resource-manager/readme.go.md
if [ -f "$FILE" ]; then
    echo "$FILE exists."
    cp "$FILE" $SWAGGER_PATH/specification/$ResourceProvider/resource-manager/readme.go.md
fi

if [ "$?" != "0" ]; then
    echo "failed to generate readme config file"
    echo "##vso[task.setvariable variable=Task_Result]failure"
else
    echo "readme config file generated"
    # cd $(Pipeline.Workspace)/s/azure-rest-api-specs
    # echo "https://$(PIPELINE_USER):$(PIPELINE_TOKEN)@github.com" > ~/.git-credentials
    # git config credential.helper store ; git config --global user.email "chunyu@microsoft.com";git config --global user.name "chunyu3;"
    # git branch; git pull origin $(WORKBRANCH); git add -A; git commit -m "autogenerated"; git push origin $(WORKBRANCH)
fi

# Generate Go-SDK
tag=$TAG
moduleName="sdk/$ResourceProvider/arm$ResourceProvider"
module="github.com/Azure/azure-sdk-for-go/$moduleName"
outputfolder="$SDK_PATH/$moduleName"
if [ "$tag" == "" ]; then
    npx autorest --use=@autorest/go@4.0.0-preview.28 --go --track2 --go-sdk-folder=$SDK_PATH --module=$module --output-folder=$outputfolder --azure-arm=true --file-prefix="zz_generated_" --clear-output-folder=false --module-version="0.0.1" $SWAGGER_PATH/specification/$ResourceProvider/resource-manager/readme.md
else
    npx autorest --use=@autorest/go@4.0.0-preview.28 --go --track2 --tag=$TAG --go-sdk-folder=$SDK_PATH --module=$module --output-folder=$outputfolder --azure-arm=true --file-prefix="zz_generated_" --clear-output-folder=false --module-version="0.0.1" $SWAGGER_PATH/specification/$ResourceProvider/resource-manager/readme.md
fi

if [ "$?" != "0" ]; then
    echo -e "\e[31m[$(date -u)] ERROR: [$OPERATION : $ResourceProvider]: Generate go sdk failed"
    exit 1
fi

#Generate Go-SDK Mock test
npx autorest --version=3.2.1 --use=https://amecodegenstorage.blob.core.windows.net/tools/autorest-tests-0.1.0-preview.tgz $SWAGGER_PATH/specification/$ResourceProvider/resource-manager/readme.md --use=@autorest/go@4.0.0-preview.24 --file-prefix="zz_generated_" --track2 --go --output-folder=$outputfolder